{% extends "base.html" %}

{% block title %}Управление врачами - Админ-панель{% endblock %}

{% block extra_styles %}
<style>
    .user-search-container {
        position: relative;
    }
    
    .user-search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .user-search-result-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    
    .user-search-result-item:hover {
        background-color: #f8f9fa;
    }
    
    .user-search-result-item:last-child {
        border-bottom: none;
    }
    
    .user-search-result-item.selected {
        background-color: #e7f3ff;
    }
    
    .user-search-result-item .user-name {
        font-weight: 500;
        color: #212529;
    }
    
    .user-search-result-item .user-email {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .user-search-no-results {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Управление врачами</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDoctorModal">
        <i class="fas fa-plus"></i> Добавить врача
    </button>
</div>

<div class="card">
    <div class="card-body">
        <!-- Search Bar -->
        <div class="mb-3">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Поиск по имени, email, специализации, месту работы...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i> Поиск
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" style="display: none;">
                            <i class="fas fa-times"></i> Очистить
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="doctorsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Фото</th>
                        <th>Имя врача</th>
                        <th>Email</th>
                        <th>Специализация</th>
                        <th>Место работы</th>
                        <th>Телефон</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                <!-- Doctors will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Page navigation" id="paginationNav" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
        
        <!-- Results info -->
        <div class="text-center text-muted mt-2" id="resultsInfo"></div>
    </div>
</div>

<!-- Add Doctor Modal -->
<div class="modal fade" id="addDoctorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить врача</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addDoctorForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addDoctorUserId" class="form-label">Выберите пользователя</label>
                        <div class="user-search-container">
                            <input type="text" 
                                   class="form-control" 
                                   id="addDoctorUserSearch" 
                                   placeholder="Начните вводить имя или email пользователя..."
                                   autocomplete="off">
                            <input type="hidden" id="addDoctorUserId" name="user_id" required>
                            <div class="user-search-dropdown" id="userSearchDropdown" style="display: none;">
                                <div class="user-search-loading" id="userSearchLoading" style="display: none;">
                                    <div class="text-center p-2">
                                        <small class="text-muted">Поиск...</small>
                                    </div>
                                </div>
                                <div class="user-search-results" id="userSearchResults"></div>
                            </div>
                        </div>
                        <div class="form-text" id="userSelectHelp">
                            Доступны только пользователи, которые еще не являются врачами
                        </div>
                        <div id="selectedUserDisplay" class="mt-2" style="display: none;">
                            <div class="alert alert-info py-2 px-3 mb-0">
                                <small>
                                    <strong>Выбран:</strong> <span id="selectedUserName"></span>
                                    <button type="button" class="btn btn-sm btn-link p-0 ms-2" id="clearSelectedUser">
                                        <i class="fas fa-times"></i> Очистить
                                    </button>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addSpecialisation" class="form-label">Специализация</label>
                        <input type="text" class="form-control" id="addSpecialisation" name="specialisation" required>
                    </div>
                    <div class="mb-3">
                        <label for="addPlaceOfWork" class="form-label">Место работы</label>
                        <input type="text" class="form-control" id="addPlaceOfWork" name="place_of_work" required>
                    </div>
                    <div class="mb-3">
                        <label for="addPhone" class="form-label">Телефон</label>
                        <input type="text" class="form-control" id="addPhone" name="phone" maxlength="255">
                        <div class="form-text">Необязательное поле</div>
                    </div>
                    <div class="mb-3">
                        <label for="addPhoto" class="form-label">Фото врача</label>
                        <input type="file" class="form-control" id="addPhoto" name="photo" accept="image/*">
                        <div class="form-text">Разрешены форматы: PNG, JPG, JPEG, GIF, WEBP. Максимальный размер: 5MB</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить врача</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Doctor Modal -->
<div class="modal fade" id="editDoctorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать врача</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editDoctorForm" enctype="multipart/form-data">
                <input type="hidden" id="editDoctorId" name="doctor_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editSpecialisation" class="form-label">Специализация</label>
                        <input type="text" class="form-control" id="editSpecialisation" name="specialisation" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPlaceOfWork" class="form-label">Место работы</label>
                        <input type="text" class="form-control" id="editPlaceOfWork" name="place_of_work" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Телефон</label>
                        <input type="text" class="form-control" id="editPhone" name="phone" maxlength="255">
                        <div class="form-text">Необязательное поле</div>
                    </div>
                    <div class="mb-3">
                        <label for="editPhoto" class="form-label">Фото врача</label>
                        <input type="file" class="form-control" id="editPhoto" name="photo" accept="image/*">
                        <div class="form-text">Разрешены форматы: PNG, JPG, JPEG, GIF, WEBP. Максимальный размер: 5MB</div>
                        <div id="currentPhoto" class="mt-2" style="display: none;">
                            <small class="text-muted">Текущее фото:</small>
                            <div class="mt-1">
                                <img id="currentPhotoImg" src="" alt="Текущее фото" style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 5px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Обновить врача</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global state
    let currentPage = 1;
    let currentSearch = '';
    const perPage = 10;

    // User search state
    let userSearchTimeout = null;
    let allDoctors = [];
    let selectedUser = null;

    $(document).ready(function() {
        loadDoctors();
        loadDoctorsForFiltering();

        // Add doctor form submission
        $('#addDoctorForm').on('submit', function(e) {
            e.preventDefault();
            addDoctor();
        });

        // Edit doctor form submission
        $('#editDoctorForm').on('submit', function(e) {
            e.preventDefault();
            updateDoctor();
        });
        
        // Search functionality
        $('#searchBtn').on('click', function() {
            currentSearch = $('#searchInput').val().trim();
            currentPage = 1;
            loadDoctors();
        });
        
        // Clear search
        $('#clearSearchBtn').on('click', function() {
            $('#searchInput').val('');
            currentSearch = '';
            currentPage = 1;
            loadDoctors();
        });
        
        // Search on Enter key
        $('#searchInput').on('keypress', function(e) {
            if (e.which === 13) {
                e.preventDefault();
                $('#searchBtn').click();
            }
        });

        // User search functionality
        setupUserSearch();
    });

    function loadDoctors() {
        const params = {
            page: currentPage,
            per_page: perPage
        };
        
        if (currentSearch) {
            params.search = currentSearch;
        }
        
        $.get('/admin/api/doctors', params)
            .done(function(response) {
                const tbody = $('#doctorsTable tbody');
                tbody.empty();

                if (response.items && response.items.length > 0) {
                    response.items.forEach(function(doctor) {
                        const photoCell = doctor.photo_url 
                            ? `<img src="${doctor.photo_url}" alt="Фото врача" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">`
                            : '<div style="width: 40px; height: 40px; background-color: #f8f9fa; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user-md text-muted"></i></div>';
                        
                        const row = `
                            <tr>
                                <td>${doctor.id}</td>
                                <td>${photoCell}</td>
                                <td>${doctor.user.full_name}</td>
                                <td>${doctor.user.email}</td>
                                <td>${doctor.specialisation}</td>
                                <td>${doctor.place_of_work}</td>
                                <td>${doctor.phone || '-'}</td>
                                <td class="table-actions">
                                    <div class="btn-group-actions">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editDoctor(${doctor.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor(${doctor.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                } else {
                    tbody.append('<tr><td colspan="8" class="text-center">Врачи не найдены</td></tr>');
                }
                
                // Update pagination
                updatePagination(response);
                
                // Update results info
                updateResultsInfo(response);
                
                // Show/hide clear search button
                if (currentSearch) {
                    $('#clearSearchBtn').show();
                } else {
                    $('#clearSearchBtn').hide();
                }
            })
            .fail(function() {
                alert('Ошибка загрузки врачей');
            });
    }
    
    function updatePagination(response) {
        const pagination = $('#pagination');
        pagination.empty();
        
        if (response.pages <= 1) {
            $('#paginationNav').hide();
            return;
        }
        
        $('#paginationNav').show();
        
        // Previous button
        const prevDisabled = response.page === 1 ? 'disabled' : '';
        pagination.append(`
            <li class="page-item ${prevDisabled}">
                <a class="page-link" href="#" onclick="goToPage(${response.page - 1}); return false;">Предыдущая</a>
            </li>
        `);
        
        // Page numbers
        const startPage = Math.max(1, response.page - 2);
        const endPage = Math.min(response.pages, response.page + 2);
        
        if (startPage > 1) {
            pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`);
            if (startPage > 2) {
                pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const active = i === response.page ? 'active' : '';
            pagination.append(`
                <li class="page-item ${active}">
                    <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                </li>
            `);
        }
        
        if (endPage < response.pages) {
            if (endPage < response.pages - 1) {
                pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            }
            pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${response.pages}); return false;">${response.pages}</a></li>`);
        }
        
        // Next button
        const nextDisabled = response.page === response.pages ? 'disabled' : '';
        pagination.append(`
            <li class="page-item ${nextDisabled}">
                <a class="page-link" href="#" onclick="goToPage(${response.page + 1}); return false;">Следующая</a>
            </li>
        `);
    }
    
    function updateResultsInfo(response) {
        const start = response.total === 0 ? 0 : (response.page - 1) * response.per_page + 1;
        const end = Math.min(response.page * response.per_page, response.total);
        const info = `Показано ${start}-${end} из ${response.total} врачей`;
        $('#resultsInfo').text(info);
    }
    
    function goToPage(page) {
        currentPage = page;
        loadDoctors();
        // Scroll to top of table
        $('html, body').animate({
            scrollTop: $('#doctorsTable').offset().top - 100
        }, 300);
    }

    function loadDoctorsForFiltering() {
        // Load all doctors to filter out users who are already doctors
        $.get('/admin/api/doctors', { per_page: 1000 })
            .done(function(response) {
                allDoctors = response.items || response;
            })
            .fail(function() {
                console.error('Ошибка загрузки списка врачей');
            });
    }

    function setupUserSearch() {
        const searchInput = $('#addDoctorUserSearch');
        const dropdown = $('#userSearchDropdown');
        const resultsContainer = $('#userSearchResults');
        const loadingIndicator = $('#userSearchLoading');
        const hiddenInput = $('#addDoctorUserId');
        const selectedDisplay = $('#selectedUserDisplay');
        const selectedNameSpan = $('#selectedUserName');

        // Handle input changes with debouncing
        searchInput.on('input', function() {
            const query = $(this).val().trim();
            
            // Clear previous timeout
            if (userSearchTimeout) {
                clearTimeout(userSearchTimeout);
            }

            // If input is cleared, hide dropdown and clear selection
            if (query === '') {
                dropdown.hide();
                return;
            }

            // Show loading indicator
            loadingIndicator.show();
            resultsContainer.hide();
            dropdown.show();

            // Debounce search (wait 300ms after user stops typing)
            userSearchTimeout = setTimeout(function() {
                searchUsers(query);
            }, 300);
        });

        // Handle focus
        searchInput.on('focus', function() {
            const query = $(this).val().trim();
            if (query && !selectedUser) {
                dropdown.show();
            }
        });

        // Handle click outside to close dropdown
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.user-search-container').length) {
                dropdown.hide();
            }
        });

        // Handle clear selected user
        $('#clearSelectedUser').on('click', function(e) {
            e.preventDefault();
            clearSelectedUser();
        });

        // Handle modal close - reset form
        $('#addDoctorModal').on('hidden.bs.modal', function() {
            clearSelectedUser();
            searchInput.val('');
            dropdown.hide();
        });

        function searchUsers(query) {
            if (!query || query.length < 2) {
                dropdown.hide();
                return;
            }

            $.get('/admin/api/users', { search: query, per_page: 50 })
                .done(function(response) {
                    loadingIndicator.hide();
                    const users = response.items || response;
                    
                    // Get user IDs who are already doctors
                    const doctorUserIds = allDoctors.map(doctor => doctor.user_id);
                    
                    // Filter out users who are already doctors
                    const availableUsers = users.filter(user => !doctorUserIds.includes(user.id));
                    
                    displayUserResults(availableUsers);
                })
                .fail(function() {
                    loadingIndicator.hide();
                    resultsContainer.html('<div class="user-search-no-results">Ошибка загрузки пользователей</div>');
                    resultsContainer.show();
                });
        }

        function displayUserResults(users) {
            resultsContainer.empty();

            if (users.length === 0) {
                resultsContainer.html('<div class="user-search-no-results">Пользователи не найдены</div>');
                resultsContainer.show();
                return;
            }

            users.forEach(function(user) {
                const item = $('<div class="user-search-result-item"></div>');
                item.html(`
                    <div class="user-name">${escapeHtml(user.full_name)}</div>
                    <div class="user-email">${escapeHtml(user.email)}</div>
                `);
                
                item.on('click', function() {
                    selectUser(user);
                });
                
                resultsContainer.append(item);
            });

            resultsContainer.show();
        }

        function selectUser(user) {
            selectedUser = user;
            hiddenInput.val(user.id);
            searchInput.val(user.full_name);
            selectedNameSpan.text(`${user.full_name} (${user.email})`);
            selectedDisplay.show();
            dropdown.hide();
            
            // Update help text
            $('#userSelectHelp').text('Пользователь выбран').removeClass('text-warning');
            $('#addDoctorForm button[type="submit"]').prop('disabled', false);
        }

        function clearSelectedUser() {
            selectedUser = null;
            hiddenInput.val('');
            searchInput.val('');
            selectedDisplay.hide();
            dropdown.hide();
            $('#userSelectHelp').text('Доступны только пользователи, которые еще не являются врачами').removeClass('text-warning');
            $('#addDoctorForm button[type="submit"]').prop('disabled', false);
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function addDoctor() {
        const userId = $('#addDoctorUserId').val();
        
        if (!userId) {
            alert('Пожалуйста, выберите пользователя');
            return;
        }
        
        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('specialisation', $('#addSpecialisation').val());
        formData.append('place_of_work', $('#addPlaceOfWork').val());
        formData.append('phone', $('#addPhone').val());
        
        // Add photo if selected
        const photoFile = $('#addPhoto')[0].files[0];
        if (photoFile) {
            // Validate file size (5MB max)
            if (photoFile.size > 5 * 1024 * 1024) {
                alert('Размер файла не должен превышать 5MB');
                return;
            }
            formData.append('photo', photoFile);
        }

        $.ajax({
            url: '/admin/api/doctors',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function() {
                $('#addDoctorModal').modal('hide');
                $('#addDoctorForm')[0].reset();
                selectedUser = null;
                $('#selectedUserDisplay').hide();
                loadDoctors();
                loadDoctorsForFiltering(); // Reload doctors list to update available options
                alert('Врач успешно добавлен');
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Ошибка добавления врача';
                alert(error);
            }
        });
    }

    function editDoctor(doctorId) {
        // Load all doctors to find the one we need
        $.get('/admin/api/doctors', { per_page: 1000 })
            .done(function(response) {
                const doctors = response.items || response;
                const doctor = doctors.find(d => d.id === doctorId);
                if (doctor) {
                    $('#editDoctorId').val(doctor.id);
                    $('#editEmail').val(doctor.user.email);
                    $('#editSpecialisation').val(doctor.specialisation);
                    $('#editPlaceOfWork').val(doctor.place_of_work);
                    $('#editPhone').val(doctor.phone || '');
                    
                    // Show current photo if exists
                    if (doctor.photo_url) {
                        $('#currentPhotoImg').attr('src', doctor.photo_url);
                        $('#currentPhoto').show();
                    } else {
                        $('#currentPhoto').hide();
                    }
                    
                    $('#editDoctorModal').modal('show');
                } else {
                    alert('Врач не найден');
                }
            })
            .fail(function() {
                alert('Ошибка загрузки данных врача');
            });
    }

    function updateDoctor() {
        const doctorId = $('#editDoctorId').val();
        const formData = new FormData();
        formData.append('email', $('#editEmail').val());
        formData.append('specialisation', $('#editSpecialisation').val());
        formData.append('place_of_work', $('#editPlaceOfWork').val());
        formData.append('phone', $('#editPhone').val());
        
        // Add photo if selected
        const photoFile = $('#editPhoto')[0].files[0];
        if (photoFile) {
            // Validate file size (5MB max)
            if (photoFile.size > 5 * 1024 * 1024) {
                alert('Размер файла не должен превышать 5MB');
                return;
            }
            formData.append('photo', photoFile);
        }

        $.ajax({
            url: `/admin/api/doctors/${doctorId}`,
            method: 'PUT',
            data: formData,
            processData: false,
            contentType: false,
            success: function() {
                $('#editDoctorModal').modal('hide');
                loadDoctors();
                alert('Врач успешно обновлен');
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Ошибка обновления врача';
                alert(error);
            }
        });
    }

    function deleteDoctor(doctorId) {
        if (confirm('Вы уверены, что хотите удалить этого врача?')) {
            $.ajax({
                url: `/admin/api/doctors/${doctorId}`,
                method: 'DELETE',
                success: function() {
                    loadDoctors();
                    loadDoctorsForFiltering(); // Reload doctors list to make the user available again
                    alert('Врач успешно удален');
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Ошибка удаления врача';
                    alert(error);
                }
            });
        }
    }
</script>
{% endblock %}
