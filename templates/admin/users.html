{% extends "base.html" %}

{% block title %}Users Management - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Users Management</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="fas fa-plus"></i> Add New User
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Users will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="addFullName" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="addEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="addEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="addPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="addPassword" name="password" required minlength="8">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="user_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editFullName" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="editPassword" name="password" minlength="8">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    loadUsers();
    
    // Add user form submission
    $('#addUserForm').on('submit', function(e) {
        e.preventDefault();
        addUser();
    });
    
    // Edit user form submission
    $('#editUserForm').on('submit', function(e) {
        e.preventDefault();
        updateUser();
    });
});

function loadUsers() {
    $.get('/admin/api/users')
        .done(function(users) {
            const tbody = $('#usersTable tbody');
            tbody.empty();
            
            users.forEach(function(user) {
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.full_name}</td>
                        <td>${user.email}</td>
                        <td>
                            <span class="badge ${user.is_guest ? 'bg-warning' : 'bg-success'}">
                                ${user.is_guest ? 'Guest' : 'Registered'}
                            </span>
                        </td>
                        <td class="table-actions">
                            <div class="btn-group-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        })
        .fail(function() {
            alert('Error loading users');
        });
}

function addUser() {
    const formData = {
        full_name: $('#addFullName').val(),
        email: $('#addEmail').val(),
        password: $('#addPassword').val()
    };
    
    $.ajax({
        url: '/admin/api/users',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function() {
            $('#addUserModal').modal('hide');
            $('#addUserForm')[0].reset();
            loadUsers();
            alert('User added successfully');
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error adding user';
            alert(error);
        }
    });
}

function editUser(userId) {
    $.get('/admin/api/users')
        .done(function(users) {
            const user = users.find(u => u.id === userId);
            if (user) {
                $('#editUserId').val(user.id);
                $('#editFullName').val(user.full_name);
                $('#editEmail').val(user.email);
                $('#editPassword').val('');
                $('#editUserModal').modal('show');
            }
        });
}

function updateUser() {
    const userId = $('#editUserId').val();
    const formData = {
        full_name: $('#editFullName').val(),
        email: $('#editEmail').val()
    };
    
    // Only include password if provided
    const password = $('#editPassword').val();
    if (password) {
        formData.password = password;
    }
    
    $.ajax({
        url: `/admin/api/users/${userId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function() {
            $('#editUserModal').modal('hide');
            loadUsers();
            alert('User updated successfully');
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error updating user';
            alert(error);
        }
    });
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        $.ajax({
            url: `/admin/api/users/${userId}`,
            method: 'DELETE',
            success: function() {
                loadUsers();
                alert('User deleted successfully');
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error deleting user';
                alert(error);
            }
        });
    }
}
</script>
{% endblock %}
